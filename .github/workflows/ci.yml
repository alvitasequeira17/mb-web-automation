name: MultiBank Automation Tests

on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to run tests on'
        required: true
        default: 'chrome'
        type: string
        options:
          - chrome
          - firefox
          - edge
      headless:
        description: 'Run in headless mode'
        required: true
        default: 'false'
        type: string

jobs:
  cross-browser-test:
    name: Cross-Browser Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Chrome
        if: ${{ github.event.inputs.browser == 'chrome' }}
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install Firefox
        if: ${{ github.event.inputs.browser == 'firefox' }}
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: latest

      - name: Install Edge
        if: ${{ github.event.inputs.browser == 'edge' }}
        uses: browser-actions/setup-edge@v1

      - name: Install Chrome dependencies
        if: ${{ github.event.inputs.browser == 'chrome' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-liberation libappindicator3-1 libasound2t64 libatk-bridge2.0-0 \
            libatk1.0-0 libcups2 libdbus-1-3 libgdk-pixbuf2.0-0 libnspr4 \
            libnss3 libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 \
            xdg-utils libu2f-udev

      - name: Start Xvfb
        if: ${{ github.event.inputs.headless == 'false' && github.event.inputs.browser == 'chrome' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          export DISPLAY=:99
          nohup Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "Xvfb started"

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run tests
        continue-on-error: true
        env:
          DISPLAY: ":99"
        run: mvn -B -q -ntp clean test -Dbrowser=${{ github.event.inputs.browser }} -Dheadless=${{ github.event.inputs.headless }}

      - name: Generate Allure Report
        if: always()
        run: mvn allure:report

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ github.event.inputs.browser }}
          path: target/allure-results/
          retention-days: 30

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.event.inputs.browser }}
          path: target/site/allure-maven-plugin/
          retention-days: 30

      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.event.inputs.browser }}
          path: target/screenshots/
          retention-days: 7

      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ github.event.inputs.browser }}
          path: target/logs/
          retention-days: 7

  publish-report:
    name: Publish Allure Report
    runs-on: ubuntu-latest
    needs: cross-browser-test
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Allure Results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true

      - name: Download Screenshots
        uses: actions/download-artifact@v4
        with:
          pattern: screenshots-*
          path: screenshots
          merge-multiple: true

      - name: Download Test Logs
        uses: actions/download-artifact@v4
        with:
          pattern: test-logs-*
          path: logs
          merge-multiple: true

#      - name: Generate and Deploy Allure Report
#        if: always()
#        uses: simple-elf/allure-report-action@master
#        with:
#          allure_results: allure-results
#          allure_history: allure-history
#          keep_reports: 20
#
#      - name: Deploy Allure Report to GitHub Pages
#        if: always()
#        uses: peaceiris/actions-gh-pages@v3
#        with:
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#          publish_branch: gh-pages
#          publish_dir: allure-history
